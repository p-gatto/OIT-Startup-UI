<div class="users-container">
    <mat-card>
        <mat-card-header>
            <div class="header-content">
                <div>
                    <mat-card-title>
                        <mat-icon>people</mat-icon>
                        Gestione Utenti
                    </mat-card-title>
                    <mat-card-subtitle>Amministra gli utenti del sistema</mat-card-subtitle>
                </div>
                <button mat-raised-button color="primary" (click)="openUserDialog()">
                    <mat-icon>person_add</mat-icon>
                    Nuovo Utente
                </button>
            </div>
        </mat-card-header>

        <mat-card-content>
            @if (loading()) {
            <div class="loading-container">
                <mat-spinner></mat-spinner>
                <p>Caricamento utenti...</p>
            </div>
            } @else {
            <div class="table-container">
                <table mat-table [dataSource]="users()" class="users-table">

                    <ng-container matColumnDef="avatar">
                        <th mat-header-cell *matHeaderCellDef>Avatar</th>
                        <td mat-cell *matCellDef="let user">
                            <div class="user-avatar">
                                {{ getInitials(user.fullName) }}
                            </div>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="fullName">
                        <th mat-header-cell *matHeaderCellDef>Nome Completo</th>
                        <td mat-cell *matCellDef="let user">
                            <div class="user-info">
                                <span class="user-name">{{ user.fullName }}</span>
                                <span class="user-username">{{ user.username }}</span>
                            </div>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="email">
                        <th mat-header-cell *matHeaderCellDef>Email</th>
                        <td mat-cell *matCellDef="let user">
                            <div class="email-container">
                                {{ user.email }}
                                @if (user.emailConfirmed) {
                                <mat-icon class="verified-icon" matTooltip="Email verificata">verified</mat-icon>
                                } @else {
                                <mat-icon class="unverified-icon" matTooltip="Email non verificata">warning</mat-icon>
                                }
                            </div>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="securityGroups">
                        <th mat-header-cell *matHeaderCellDef>Gruppi Sicurezza</th>
                        <td mat-cell *matCellDef="let user">
                            <div class="chips-container">
                                @for (group of user.securityGroups; track group.id) {
                                <mat-chip [class]="getGroupChipClass(group)"
                                    [matTooltip]="group.description || group.name">
                                    {{ group.name }}
                                </mat-chip>
                                }
                                @if (user.securityGroups.length === 0) {
                                <span class="no-groups">Nessun gruppo</span>
                                }
                            </div>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="status">
                        <th mat-header-cell *matHeaderCellDef>Stato</th>
                        <td mat-cell *matCellDef="let user">
                            <div class="status-container">
                                @if (user.isActive) {
                                <mat-chip class="status-chip active">Attivo</mat-chip>
                                } @else {
                                <mat-chip class="status-chip inactive">Disattivo</mat-chip>
                                }
                            </div>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="lastLogin">
                        <th mat-header-cell *matHeaderCellDef>Ultimo Accesso</th>
                        <td mat-cell *matCellDef="let user">
                            @if (user.lastLoginAt) {
                            {{ user.lastLoginAt | date:'dd/MM/yyyy HH:mm' }}
                            } @else {
                            <span class="never-logged">Mai effettuato</span>
                            }
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef>Azioni</th>
                        <td mat-cell *matCellDef="let user">
                            <div class="actions-container">
                                <button mat-icon-button (click)="openUserDialog(user)" matTooltip="Modifica utente">
                                    <mat-icon>edit</mat-icon>
                                </button>
                                <button mat-icon-button (click)="resetPassword(user)" matTooltip="Reset password">
                                    <mat-icon>lock_reset</mat-icon>
                                </button>
                                <button mat-icon-button (click)="deleteUser(user)" [disabled]="user.id === 1"
                                    [matTooltip]="user.id === 1 ? 'Non puoi eliminare l\'admin di sistema' : 'Elimina utente'"
                                    class="delete-button">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </div>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>

                @if (users().length === 0) {
                <div class="no-data">
                    <mat-icon>people_outline</mat-icon>
                    <h3>Nessun utente trovato</h3>
                    <p>Inizia creando il primo utente</p>
                    <button mat-raised-button color="primary" (click)="openUserDialog()">
                        <mat-icon>person_add</mat-icon>
                        Crea primo utente
                    </button>
                </div>
                }
            </div>
            }
        </mat-card-content>
    </mat-card>
</div>